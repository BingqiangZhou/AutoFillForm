name: Build AutoFillForm
on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version tag (e.g. v5.0.1)'
        required: true
        default: 'v5.0.0'
  push:
    tags: ['v*']

permissions:
  contents: write

jobs:
  build:
    strategy:
      fail-fast: false
      matrix:
        include:
          - { os: windows-latest, platform: windows, artifact_suffix: windows-x64 }
          - { os: macos-latest,   platform: macos,   artifact_suffix: macos-x64 }
          - { os: ubuntu-latest,  platform: linux,   artifact_suffix: linux-x64 }

    runs-on: ${{ matrix.os }}

    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Determine version
        id: version
        shell: bash
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "version=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
          else
            echo "version=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
          fi

      # ── Dependencies ──────────────────────────────────────────────

      - name: Install system dependencies (Linux)
        if: matrix.platform == 'linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            python3-xlib xdotool xvfb scrot \
            libxkbcommon-x11-0 libxcb-icccm4 libxcb-image0 \
            libxcb-keysyms1 libxcb-randr0 libxcb-render-util0 \
            libxcb-xinerama0 libxcb-shape0 libxcb-cursor0 \
            libegl1 libglib2.0-0

      - name: Install Python dependencies
        shell: bash
        run: |
          cd Codes
          pip install -r requirements.txt
          pip install pyautogui
          pip install PySide6==6.6.1

      - name: Install Windows-specific dependencies
        if: matrix.platform == 'windows'
        shell: bash
        run: pip install -r Codes/requirements-windows.txt

      - name: Verify PySide6
        shell: bash
        run: python -c "from PySide6.QtCore import QCoreApplication; print('PySide6 OK')"

      # ── Build ─────────────────────────────────────────────────────

      - name: Build with Nuitka (Windows)
        if: matrix.platform == 'windows'
        uses: Nuitka/Nuitka-Action@v1.4
        with:
          nuitka-version: "2.8.10"
          script-name: Codes/app.py
          mode: standalone
          enable-plugins: pyside6
          windows-console-mode: disable
          include-data-dir: Codes/rules/=rules/
          include-package-data: playwright
          output-dir: build
          output-file: AutoFillForm.exe
          noinclude-setuptools-mode: nofollow
          noinclude-pytest-mode: nofollow
          noinclude-unittest-mode: nofollow

      - name: Build with Nuitka (macOS)
        if: matrix.platform == 'macos'
        uses: Nuitka/Nuitka-Action@v1.4
        with:
          nuitka-version: "2.8.10"
          script-name: Codes/app.py
          mode: app
          enable-plugins: pyside6
          macos-app-mode: gui
          include-data-dir: Codes/rules/=rules/
          include-package-data: playwright
          noinclude-data-files: "playwright/driver/node"
          output-dir: build
          output-file: AutoFillForm
          noinclude-setuptools-mode: nofollow
          noinclude-pytest-mode: nofollow
          noinclude-unittest-mode: nofollow

      - name: Build with Nuitka (Linux)
        if: matrix.platform == 'linux'
        uses: Nuitka/Nuitka-Action@v1.4
        with:
          nuitka-version: "2.8.10"
          script-name: Codes/app.py
          mode: standalone
          enable-plugins: pyside6
          include-data-dir: Codes/rules/=rules/
          include-package-data: playwright
          noinclude-data-files: "playwright/driver/node"
          output-dir: build
          output-file: AutoFillForm
          noinclude-setuptools-mode: nofollow
          noinclude-pytest-mode: nofollow
          noinclude-unittest-mode: nofollow

      - name: Restore Playwright node binary (macOS / Linux)
        if: matrix.platform != 'windows'
        shell: bash
        run: |
          if [ "${{ matrix.platform }}" = "macos" ]; then
            DIST_DIR=$(find build -maxdepth 1 -type d -name "*.app" | head -1)/Contents/MacOS
          else
            DIST_DIR=$(find build -maxdepth 1 -type d -name "*.dist" | head -1)
            if [ -z "$DIST_DIR" ]; then
              DIST_DIR=$(find build -maxdepth 1 -type d ! -path build | head -1)
            fi
          fi
          PW_NODE=$(python -c "import playwright; import os; print(os.path.join(os.path.dirname(playwright.__file__), 'driver', 'node'))")
          mkdir -p "$DIST_DIR/playwright/driver"
          cp "$PW_NODE" "$DIST_DIR/playwright/driver/node"
          chmod +x "$DIST_DIR/playwright/driver/node"

      # ── Package ───────────────────────────────────────────────────

      - name: Package distribution (Windows)
        if: matrix.platform == 'windows'
        id: package-win
        shell: pwsh
        run: |
          $distDir = Get-ChildItem -Path build -Directory -Filter "*.dist" |
                     Select-Object -First 1
          if (-not $distDir) {
            $distDir = Get-ChildItem -Path build -Directory | Select-Object -First 1
          }
          $version = "${{ steps.version.outputs.version }}"
          $zipName = "AutoFillForm-${version}-windows-x64.zip"
          Compress-Archive -Path "$($distDir.FullName)/*" `
                           -DestinationPath "build/$zipName"
          echo "ZIP_PATH=build/$zipName" >> $env:GITHUB_OUTPUT

      - name: Package distribution (macOS)
        if: matrix.platform == 'macos'
        id: package-macos
        shell: bash
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          ZIP_NAME="AutoFillForm-${VERSION}-${{ matrix.artifact_suffix }}.zip"
          cd build && zip -r -y "$ZIP_NAME" AutoFillForm.app
          cd ..
          echo "ZIP_PATH=build/$ZIP_NAME" >> $GITHUB_OUTPUT

      - name: Package distribution (Linux)
        if: matrix.platform == 'linux'
        id: package-linux
        shell: bash
        run: |
          DIST_DIR=$(find build -maxdepth 1 -type d -name "*.dist" | head -1)
          if [ -z "$DIST_DIR" ]; then
            DIST_DIR=$(find build -maxdepth 1 -type d | tail -1)
          fi
          VERSION="${{ steps.version.outputs.version }}"
          ZIP_NAME="AutoFillForm-${VERSION}-${{ matrix.artifact_suffix }}.zip"
          cd "$DIST_DIR"
          zip -r "../../build/$ZIP_NAME" .
          cd ../..
          echo "ZIP_PATH=build/$ZIP_NAME" >> $GITHUB_OUTPUT

      - name: Set ZIP path
        id: package
        shell: bash
        run: |
          if [ "${{ matrix.platform }}" = "windows" ]; then
            echo "ZIP_PATH=${{ steps.package-win.outputs.ZIP_PATH }}" >> $GITHUB_OUTPUT
          elif [ "${{ matrix.platform }}" = "macos" ]; then
            echo "ZIP_PATH=${{ steps.package-macos.outputs.ZIP_PATH }}" >> $GITHUB_OUTPUT
          else
            echo "ZIP_PATH=${{ steps.package-linux.outputs.ZIP_PATH }}" >> $GITHUB_OUTPUT
          fi

      - uses: actions/upload-artifact@v4
        with:
          name: AutoFillForm-${{ steps.version.outputs.version }}-${{ matrix.artifact_suffix }}
          path: ${{ steps.package.outputs.ZIP_PATH }}
          retention-days: 30

  # ════════════════════════════════════════════════════════════════════
  # Release job — runs after all builds succeed
  # ════════════════════════════════════════════════════════════════════

  release:
    if: startsWith(github.ref, 'refs/tags/')
    needs: build
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0   # full history for git-cliff

      - name: Determine version
        id: version
        shell: bash
        run: echo "version=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
          pattern: AutoFillForm-*

      - name: Collect zip files
        id: zips
        shell: bash
        run: |
          mkdir -p release_assets
          find artifacts -name "*.zip" -exec cp {} release_assets/ \;
          ls -lh release_assets/

      - name: Generate release notes with git-cliff
        id: notes
        shell: bash
        run: |
          pip install git-cliff
          NOTES=$(git-cliff --latest --strip all 2>/dev/null || echo "")
          if [ -z "$NOTES" ]; then
            NOTES="Release ${{ steps.version.outputs.version }}"
          fi
          # Write to file to preserve multiline
          echo "$NOTES" > release_notes.md

      - name: Build release body
        shell: bash
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          cp release_notes.md release_body.md
          cat >> release_body.md <<EOF

          ---

          ### 下载
          | 平台 | 文件 |
          |------|------|
          | Windows x64 | \`AutoFillForm-${VERSION}-windows-x64.zip\` |
          | macOS x64   | \`AutoFillForm-${VERSION}-macos-x64.zip\` |
          | Linux x64   | \`AutoFillForm-${VERSION}-linux-x64.zip\` |

          ### 安装
          1. 下载对应平台的 zip 文件并解压
          2. **Windows**: 运行 \`AutoFillForm.exe\`
          3. **macOS**: 运行 \`AutoFillForm.app\`
          4. **Linux**: \`chmod +x AutoFillForm && ./AutoFillForm\`

          ### 浏览器
          应用支持自动检测系统浏览器（Edge / Chrome）。
          如果系统没有 Edge 或 Chrome，需安装 Playwright 内置浏览器：
          \`\`\`
          pip install playwright==1.40.0
          playwright install chromium
          \`\`\`
          EOF

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: release_assets/*
          name: AutoFillForm ${{ steps.version.outputs.version }}
          body_path: release_body.md
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
