name: Build AutoFillForm
on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version tag (e.g. v5.0.1)'
        required: true
        default: 'v5.0.0'
  push:
    tags: ['v*']

permissions:
  contents: write

jobs:
  build:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Determine version
        id: version
        shell: bash
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "version=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
          else
            echo "version=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
          fi

      - name: Install dependencies
        run: |
          cd Codes
          pip install -r requirements.txt
          pip install pyautogui
          # Verify PyQt6 installation
          python -c "import PyQt6; print('PyQt6 installed successfully')"

      - name: Build with Nuitka
        uses: Nuitka/Nuitka-Action@v1.3
        with:
          nuitka-version: main
          script-name: Codes/app.py
          mode: standalone
          enable-plugins: pyqt6
          windows-console-mode: disable
          include-data-dir: Codes/rules/=rules/
          include-package-data: playwright
          output-dir: build
          output-file: AutoFillForm.exe

      - name: Package distribution
        id: package
        shell: pwsh
        run: |
          $distDir = Get-ChildItem -Path build -Directory -Filter "*.dist" |
                     Select-Object -First 1
          if (-not $distDir) {
            $distDir = Get-ChildItem -Path build -Directory | Select-Object -First 1
          }
          $version = "${{ steps.version.outputs.version }}"
          $zipName = "AutoFillForm-${version}-windows-x64.zip"
          Compress-Archive -Path "$($distDir.FullName)/*" `
                           -DestinationPath "build/$zipName"
          echo "ZIP_PATH=build/$zipName" >> $env:GITHUB_OUTPUT

      - uses: actions/upload-artifact@v4
        with:
          name: AutoFillForm-${{ steps.version.outputs.version }}-windows-x64
          path: ${{ steps.package.outputs.ZIP_PATH }}
          retention-days: 30

      - name: Create GitHub Release
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v2
        with:
          files: ${{ steps.package.outputs.ZIP_PATH }}
          name: AutoFillForm ${{ steps.version.outputs.version }}
          body: |
            ## AutoFillForm ${{ steps.version.outputs.version }}

            ### 安装
            1. 下载并解压 zip 文件
            2. 运行 `AutoFillForm.exe`

            ### 浏览器
            应用支持自动检测系统浏览器（Edge / Chrome）。
            如果系统没有 Edge 或 Chrome，需安装 Playwright 内置浏览器：
            ```
            pip install playwright==1.40.0
            playwright install chromium
            ```
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
